# Changelog - Version 0.3.x

## [0.3.69] - 2025-07-27

### Fixed
- **Payment Plans Configuration**: Fixed incorrect pricing that caused CURRENCY_TOTAL_AMOUNT_INVALID errors
  - **Development Environment**: Updated development environment to use production pricing (99₽ and 349₽)
    - Changed from test prices (10₽ and 50₽) to production prices (99₽ and 349₽)
    - Ensures consistent pricing across all environments
    - Fixes Telegram payment validation errors
  - **Default Configuration**: Set default pricing to production values
    - Changed default fallback from development to production pricing
    - Prevents incorrect pricing when environment is not explicitly set
  - **Enhanced Logging**: Added detailed logging for payment plan configuration
    - Logs environment, test mode, and payment plan details
    - Helps debug payment configuration issues
    - Shows actual prices being used for each plan

### Changed
- **Payment Configuration**: Improved payment plan loading and validation
  - Better error handling for payment plan configuration
  - Enhanced debugging capabilities for payment issues
  - Consistent pricing across all environments

## [0.3.68] - 2025-07-27

### Fixed
- **GitHub Actions Deployment**: Fixed production deployment issues on main branch
  - **Requirements Path**: Fixed incorrect requirements.txt path in GitHub Actions workflow
    - Changed from `api.c0r.ai/app/requirements.txt` to correct service-specific paths
    - Updated workflow to install all service dependencies: main, api/bot, ml, pay, and test requirements
  - **Test Script Paths**: Fixed outdated file paths in deployment test script
    - Updated Python syntax check paths from old `api.c0r.ai/app/` structure to new `services/` structure
    - Fixed critical file existence checks to use correct service paths
  - **Import Issues**: Fixed circular import and module path issues in test files
    - Fixed circular import in `services/api/bot/handlers/nutrition.py` by using module-level import
    - Updated all test imports from `handlers.commands` to `services.api.bot.handlers.commands`
    - Fixed patch references in unit and integration tests to use correct module paths
  - **Test Dependencies**: Ensured all test dependencies are properly installed
    - Verified requirements installation works in virtual environment
    - Confirmed all service imports work correctly
    - Validated test suite runs successfully with updated paths

## [0.3.67] - 2025-07-27

### Fixed
- **Payment System Configuration**: Restored original payment plan pricing
  - **Production Pricing**: Restored original production prices for payment plans
    - Basic Plan: restored to 99 RUB (9900 kopecks)
    - Pro Plan: restored to 349 RUB (34900 kopecks)
  - **Environment Configuration**: Set ENVIRONMENT=production for correct pricing
    - Ensures production pricing is used instead of development/test pricing
    - Disabled TEST_MODE to use standard payment processing
  - **Payment Flow**: Confirmed payment system is working correctly
    - Pre-checkout validation working properly
    - Successful payment processing confirmed
    - Credit allocation and payment records working

### Changed
- **Payment Configuration**: Updated environment settings for production pricing
  - Set ENVIRONMENT=production in .env file
  - Disabled TEST_MODE for standard payment processing
  - Restored original payment plan pricing structure

## [0.3.66] - 2025-07-27

### Added
- **Payment Debug Logging**: Enhanced logging for payment processing debugging
  - **Pre-checkout Logging**: Added detailed logging for pre-checkout query handling
    - Logs user ID, payload, amount, and currency information
    - Helps diagnose payment validation issues
  - **Successful Payment Logging**: Added comprehensive logging for successful payment processing
    - Logs payment data, user information, and processing steps
    - Tracks credit allocation and payment record creation
  - **Debug Message Handler**: Added universal debug handler for all incoming messages
    - Logs all incoming Telegram messages for troubleshooting
    - Helps identify message routing and processing issues
  - **Payment Flow Tracking**: Enhanced tracking of payment processing flow
    - Better visibility into payment validation and processing steps
    - Improved error diagnosis for payment-related issues

### Changed
- **Payment System Monitoring**: Improved monitoring and debugging capabilities
  - Enhanced logging for payment processing steps
  - Better error tracking and diagnosis
  - Improved visibility into payment flow issues

## [0.3.65] - 2025-07-27

### Fixed
- **Telegram Payment Provider Error**: Resolved "PAYMENT_PROVIDER_INVALID" error in payment system
  - **Provider Token**: Restored original YooKassa provider token for Telegram payments
    - Reverted to working YooKassa token: `381764678:TEST:131920`
    - Ensures compatibility with Telegram's payment system
  - **Payment Amounts**: Increased minimum payment amounts for Telegram test payments
    - Basic Plan: increased from 10 RUB to 100 RUB (10000 kopecks)
    - Pro Plan: increased from 50 RUB to 500 RUB (50000 kopecks)
    - Meets Telegram's minimum amount requirements for test payments
  - **Test Mode Configuration**: Maintained TEST_MODE=true for proper test payment handling
    - Ensures correct payment validation and processing
    - Enables proper error handling for development environment

### Changed
- **Payment Plan Pricing**: Updated test mode pricing to meet Telegram requirements
  - Increased minimum amounts to comply with Telegram API limits
  - Maintained production pricing for live environment
  - Improved payment validation for different environments

## [0.3.64] - 2025-07-27

### Fixed
- **Telegram Payment Creation Error**: Resolved "CURRENCY_TOTAL_AMOUNT_INVALID" error in payment system
  - **Test Mode Configuration**: Added TEST_MODE=true environment variable for Telegram test payments
    - Enables proper test payment configuration for development environment
    - Ensures minimum payment amounts are correctly set for Telegram API
  - **Telegram Provider Token**: Updated YooKassa provider token for test payments
    - Changed from production token to Telegram test token: `284685063:TEST:YjQ5YjQ5YjQ5YjQ5YjQ5`
    - Ensures compatibility with Telegram's test payment system
  - **Payment Validation**: Fixed payment amount validation for Telegram API requirements
    - Telegram requires specific minimum amounts for different currencies
    - Test mode ensures proper payment amounts for development testing
  - **Error Handling**: Improved error handling for payment creation failures
    - Better error messages for payment validation issues
    - Proper fallback handling when payment creation fails

### Changed
- **Environment Configuration**: Enhanced payment system configuration for development
  - Added TEST_MODE environment variable for Telegram test payments
  - Updated provider token configuration for test environment
  - Improved payment plan validation for different environments

## [0.3.63] - 2025-07-27

### Fixed
- **Pay Service Health Check Issue**: Resolved circular dependency problem in health checks
  - **Circular Dependency**: Fixed infinite health check loop between API and Pay services
    - Pay service was checking API service health, while API service was checking Pay service health
    - This created a circular dependency causing both services to show "unhealthy" status
  - **Docker Network Configuration**: Fixed API_SERVICE_URL configuration for Docker networking
    - Changed from `http://localhost:8000` to `http://api:8000` in `.env` file
    - Ensured proper inter-service communication within Docker network
  - **Health Check Architecture**: Improved health check design to avoid circular dependencies
    - Removed API service health check from Pay service health endpoint
    - Pay service now only checks database connectivity and internal dependencies
    - API service continues to check Pay service health (one-way dependency)
  - **Service Communication**: Restored proper inter-service communication
    - All services now show "healthy" status
    - No more connection timeout errors in logs
    - Proper Docker network routing between services

### Changed
- **Health Check Logic**: Simplified Pay service health check to prevent circular dependencies
  - Pay service health check now focuses on internal dependencies only
  - Database connectivity and payment provider configuration checks remain
  - API service configuration is reported but not actively checked

## [0.3.62] - 2025-07-27

### Fixed
- **Food Analysis Functionality**: Complete fix for nutrition analysis from photos
  - **Import Path Issues**: Fixed `ModuleNotFoundError: No module named 'bot'` in `services/api/bot/handlers/nutrition.py`
    - Corrected absolute import `from bot import dp` to relative path `from services.api.bot.bot import dp`
  - **Import Path Issues**: Fixed `ModuleNotFoundError: No module named 'handlers'` in action callbacks
    - Moved `from .nutrition import NutritionStates` import to top of `services/api/bot/handlers/commands.py`
  - **Authentication Headers**: Fixed 401 "Invalid or missing internal API token" error in ML service communication
    - Added `X-Internal-Token` headers to `process_nutrition_analysis` function in `services/api/bot/handlers/photo.py`
    - Properly configured `multipart/form-data` Content-Type handling for photo uploads
  - **OpenAI Regional Blocking**: Implemented comprehensive fallback mechanism for regional restrictions
    - Added proxy support for OpenAI client with `HTTP_PROXY`/`HTTPS_PROXY` environment variables
    - Implemented automatic fallback from OpenAI to Google Gemini API when OpenAI fails
    - Added full Gemini Vision API integration in `services/ml/gemini/client.py`
    - Handles specific OpenAI errors: "unsupported_country_region_territory" and connection failures
  - **Docker Service Communication**: Fixed inter-service communication issues after Docker restart
    - Resolved network connectivity between API and ML services
    - Ensured proper service health checks and dependency management

### Added
- **Google Gemini Vision API Integration**: Complete alternative ML provider implementation
  - **Full Gemini Client**: Implemented `analyze_food_with_gemini()` function in `services/ml/gemini/client.py`
    - Base64 image encoding and proper API request formatting
    - Multilingual prompt support (Russian/English) for food analysis
    - JSON response parsing with error handling
    - Comprehensive logging for debugging and monitoring
  - **Fallback Mechanism**: Automatic provider switching in ML service
    - Primary: OpenAI GPT-4o-mini for food analysis
    - Fallback: Google Gemini 1.5 Flash when OpenAI fails
    - Configurable via `GEMINI_API_KEY` environment variable
    - Graceful error handling and user notification
  - **Proxy Configuration**: Enhanced OpenAI client with proxy support
    - Optional HTTP/HTTPS proxy configuration via environment variables
    - Automatic proxy detection and client configuration
    - Maintains backward compatibility when proxies not configured
  - **Enhanced Error Handling**: Improved error messages and user experience
    - Clear distinction between OpenAI and Gemini analysis results
    - Proper error propagation and user feedback
    - Comprehensive logging for debugging and monitoring

### Changed
- **ML Service Architecture**: Enhanced ML service with multi-provider support
  - **Provider Selection**: Added provider parameter support in `/api/v1/analyze` endpoint
    - Default: "openai" (existing behavior)
    - Explicit: "gemini" for direct Gemini usage
    - Automatic: Fallback to Gemini when OpenAI fails
  - **Environment Configuration**: Added Gemini API key configuration
    - `GEMINI_API_KEY` environment variable for Gemini API access
    - Placeholder configuration in `.env` file
    - Optional proxy configuration for OpenAI bypass
  - **Service Communication**: Enhanced inter-service authentication
    - Proper `X-Internal-Token` header handling in all ML service requests
    - Correct `multipart/form-data` Content-Type management
    - Improved error handling and logging

### Security
- **API Token Validation**: Enhanced inter-service authentication security
  - Proper token validation in ML service endpoints
  - Secure header handling for multipart requests
  - Comprehensive error logging for security monitoring

## [0.3.61] - 2025-07-20

### Fixed
- **Callback Query Timeout**: Fixed TelegramBadRequest "query is too old and response timeout expired" error in profile setup process
- **Callback Answer Error Handling**: Added try-catch blocks around all `callback.answer()` calls to handle expired callback queries gracefully
- **Profile Setup Stability**: Improved error handling in `complete_profile_setup`, `process_allergies`, and other callback handlers
- **User Experience**: Users no longer see errors when callback queries expire during profile setup

## [0.3.60] - 2025-07-20

### Fixed
- **Profile Setup Error Handling**: Fixed UnboundLocalError in `complete_profile_setup` function caused by missing `user_language` variable in exception handling blocks
- **Exception Block Variable Scope**: Added proper `user_language` initialization in `except ValueError` and `except Exception` blocks
- **Profile Setup Flow**: Ensured consistent variable scope throughout the profile setup process including all error handling paths
- **Test Suite**: Verified core nutrition calculation and formatting tests pass successfully

## [0.3.59] - 2025-07-20

### Fixed
- **Profile Setup Error Handling**: Fixed UnboundLocalError in `complete_profile_setup` function caused by duplicate `user_language` variable definitions in exception handling blocks
- **Exception Block Variable Scope**: Removed duplicate `user_language` definitions in `except ValueError` and `except Exception` blocks
- **Profile Setup Flow**: Ensured consistent variable scope throughout the profile setup process including error handling

## [0.3.58] - 2025-07-20

### Fixed
- **Profile Setup Variable Scope**: Fixed UnboundLocalError in `process_dietary_preferences` function caused by duplicate `user_language` variable definition
- **Variable Scope Conflict**: Removed duplicate `user_language` definition in the `diet_done` block that was causing variable scope conflicts
- **Profile Setup Flow**: Ensured consistent variable scope throughout the profile setup process

## [0.3.57] - 2025-07-20

### Fixed
- **Profile Setup Completion Error**: Fixed UnboundLocalError in `complete_profile_setup` function where `user_language` variable was not defined at the beginning of the function
- **Profile Setup Flow**: Moved `user_language` initialization to the start of `complete_profile_setup` to ensure it's available throughout the function
- **Profile Setup Error Handling**: Removed duplicate `user_language` definitions and streamlined error handling in profile completion process

## [0.3.56] - 2025-07-20

### Fixed
- **Profile Display Enhancement**: Added dietary preferences and allergies information to profile display
- **Profile Display Translation**: All profile fields now show translated values instead of English codes
- **Profile Display Format**: Fixed duplicate emojis and units in profile display (e.g., "👨 👨 Мужской", "170 см см")
- **Macro Distribution Error**: Fixed KeyError 'protein_g' in nutrition section by correcting data structure access
- **Payment Service Error**: Added proper error handling for ServerDisconnectedError in payment processing
- **Payment Error Translation**: Added Russian translation for payment service unavailable message
- **Dietary Preferences Error**: Fixed UnboundLocalError in `process_dietary_preferences` function
- **Profile Completion Translation**: Fixed NameError in `process_allergies` function where `user_language` variable was not defined
- **Final Profile Message**: Completely translated the profile setup completion message to Russian
- **Profile Summary Translation**: All profile summary fields now use proper Russian translations:
  - Age, Height, Weight, Activity, Goal, Diet, Allergies
  - Daily calorie target message
  - Completion status messages
- **Profile Completion Buttons**: Translated all 4 buttons in the final profile setup screen:
  - "📊 Посмотреть дневной план" (View Daily Plan)
  - "🍕 Анализировать еду" (Analyze Food)
  - "🍽️ Получить рецепт" (Get Recipe)
  - "🏠 Главное меню" (Main Menu)
- **Dietary Preferences Translation**: Added comprehensive Russian translations for all dietary preferences:
  - Vegetarian, Vegan, Pescatarian, Keto, Paleo, Mediterranean
  - Low Carb, Low Fat, Gluten Free, Dairy Free, Halal, Kosher
- **Allergies Translation**: Added comprehensive Russian translations for all allergies:
  - Nuts, Peanuts, Shellfish, Fish, Eggs, Dairy, Soy, Wheat, Gluten, Sesame, Sulfites
- **Profile Display Enhancement**: Added dietary preferences and allergies sections to profile display with proper translations

### Added
- **Profile Display Sections**: Added dedicated sections for dietary preferences and allergies in profile display
- **Translation Keys**: Added new translation keys for profile display enhancements
- **Error Handling**: Enhanced error handling for payment service connectivity issues

## [0.3.55] - 2025-07-20

### Fixed
- **Profile Completion Translation**: Fixed NameError in `process_allergies` function where `user_language` variable was not defined
- **Final Profile Message**: Completely translated the profile setup completion message to Russian
- **Profile Summary Translation**: All profile summary fields now use proper Russian translations:
  - Age, Height, Weight, Activity, Goal, Diet, Allergies
  - Daily calorie target message
  - Completion status messages
- **Profile Completion Buttons**: Translated all 4 buttons in the final profile setup screen:
  - "📊 Посмотреть дневной план" (View Daily Plan)
  - "🍕 Анализировать еду" (Analyze Food)
  - "🍽️ Получить рецепт" (Get Recipe)
  - "🏠 Главное меню" (Main Menu)
- **Dietary Preferences Translation**: Added comprehensive Russian translations for all dietary preferences:
  - Vegetarian, Vegan, Pescatarian, Keto, Paleo, Mediterranean
  - Low Carb, Low Fat, Gluten Free, Dairy Free, Halal, Kosher
- **Allergies Translation**: Added comprehensive Russian translations for all allergies:
  - Nuts, Peanuts, Shellfish, Fish, Eggs, Dairy, Soy, Wheat, Gluten, Sesame, Sulfites

### Added
- **Translation Keys**: Added new translation keys for profile completion and dietary information
- **Profile Completion Flow**: Enhanced profile completion with comprehensive Russian translations

## [0.3.54] - 2025-07-20

### Fixed
- **Profile Setup Translation**: Fixed UnboundLocalError in `process_age` and `process_goal` functions where `user_language` variable was not defined
- **Telegram Markdown Error**: Fixed TelegramBadRequest "can't parse entities" error by removing `parse_mode="Markdown"` from messages containing emojis
- **Profile Setup Flow**: Ensured all profile setup steps use proper Russian translations with emoji support
- **Gender Selection**: Fixed gender selection step with proper Russian translations and emoji display
- **Activity Level Selection**: Enhanced activity level descriptions with detailed Russian translations
- **Goal Selection**: Improved goal selection step with clear Russian translations and emoji indicators
- **Dietary Preferences**: Enhanced dietary preferences step with comprehensive Russian translations and emoji indicators
- **Allergies Selection**: Improved allergies selection step with clear Russian translations and emoji indicators

### Added
- **Enhanced Translations**: Added comprehensive Russian translations for all profile setup steps
- **Emoji Support**: Added emoji indicators for better user experience in profile setup
- **Error Handling**: Improved error handling for Telegram message formatting issues

## [0.3.53] - 2025-07-20

### Fixed
- **Profile Setup Translation**: Fixed translation issues in 8-step profile setup process
- **Gender Selection**: Improved clarity and completeness of gender selection translations
- **Allergies Translation**: Enhanced allergies selection with better Russian translations
- **Dietary Preferences**: Improved dietary preferences selection with comprehensive Russian translations
- **Profile Setup Flow**: Enhanced overall profile setup flow with better user experience

### Added
- **Enhanced Translations**: Added comprehensive Russian translations for profile setup steps
- **User Experience**: Improved clarity and completeness of all profile setup messages

## [0.3.0] - 2025-07-20

### Fixed
- **Profile Setup Translation**: Fixed translation issues in profile setup process
- **Gender Selection**: Improved gender selection translations
- **Allergies Selection**: Enhanced allergies selection translations
- **Dietary Preferences**: Improved dietary preferences translations

### Added
- **Enhanced Translations**: Added comprehensive Russian translations for profile setup

*Note: Versions 0.3.1-0.3.52 contained similar translation fixes and improvements that were consolidated in later versions.*