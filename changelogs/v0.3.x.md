# Changelog - Version 0.3.x

## [0.3.62] - 2025-07-27

### Fixed
- **Food Analysis Functionality**: Complete fix for nutrition analysis from photos
  - **Import Path Issues**: Fixed `ModuleNotFoundError: No module named 'bot'` in `services/api/bot/handlers/nutrition.py`
    - Corrected absolute import `from bot import dp` to relative path `from services.api.bot.bot import dp`
  - **Import Path Issues**: Fixed `ModuleNotFoundError: No module named 'handlers'` in action callbacks
    - Moved `from .nutrition import NutritionStates` import to top of `services/api/bot/handlers/commands.py`
  - **Authentication Headers**: Fixed 401 "Invalid or missing internal API token" error in ML service communication
    - Added `X-Internal-Token` headers to `process_nutrition_analysis` function in `services/api/bot/handlers/photo.py`
    - Properly configured `multipart/form-data` Content-Type handling for photo uploads
  - **OpenAI Regional Blocking**: Implemented comprehensive fallback mechanism for regional restrictions
    - Added proxy support for OpenAI client with `HTTP_PROXY`/`HTTPS_PROXY` environment variables
    - Implemented automatic fallback from OpenAI to Google Gemini API when OpenAI fails
    - Added full Gemini Vision API integration in `services/ml/gemini/client.py`
    - Handles specific OpenAI errors: "unsupported_country_region_territory" and connection failures
  - **Docker Service Communication**: Fixed inter-service communication issues after Docker restart
    - Resolved network connectivity between API and ML services
    - Ensured proper service health checks and dependency management

### Added
- **Google Gemini Vision API Integration**: Complete alternative ML provider implementation
  - **Full Gemini Client**: Implemented `analyze_food_with_gemini()` function in `services/ml/gemini/client.py`
    - Base64 image encoding and proper API request formatting
    - Multilingual prompt support (Russian/English) for food analysis
    - JSON response parsing with error handling
    - Comprehensive logging for debugging and monitoring
  - **Fallback Mechanism**: Automatic provider switching in ML service
    - Primary: OpenAI GPT-4o-mini for food analysis
    - Fallback: Google Gemini 1.5 Flash when OpenAI fails
    - Configurable via `GEMINI_API_KEY` environment variable
    - Graceful error handling and user notification
  - **Proxy Configuration**: Enhanced OpenAI client with proxy support
    - Optional HTTP/HTTPS proxy configuration via environment variables
    - Automatic proxy detection and client configuration
    - Maintains backward compatibility when proxies not configured
  - **Enhanced Error Handling**: Improved error messages and user experience
    - Clear distinction between OpenAI and Gemini analysis results
    - Proper error propagation and user feedback
    - Comprehensive logging for debugging and monitoring

### Changed
- **ML Service Architecture**: Enhanced ML service with multi-provider support
  - **Provider Selection**: Added provider parameter support in `/api/v1/analyze` endpoint
    - Default: "openai" (existing behavior)
    - Explicit: "gemini" for direct Gemini usage
    - Automatic: Fallback to Gemini when OpenAI fails
  - **Environment Configuration**: Added Gemini API key configuration
    - `GEMINI_API_KEY` environment variable for Gemini API access
    - Placeholder configuration in `.env` file
    - Optional proxy configuration for OpenAI bypass
  - **Service Communication**: Enhanced inter-service authentication
    - Proper `X-Internal-Token` header handling in all ML service requests
    - Correct `multipart/form-data` Content-Type management
    - Improved error handling and logging

### Security
- **API Token Validation**: Enhanced inter-service authentication security
  - Proper token validation in ML service endpoints
  - Secure header handling for multipart requests
  - Comprehensive error logging for security monitoring

## [0.3.61] - 2025-07-20

### Fixed
- **Callback Query Timeout**: Fixed TelegramBadRequest "query is too old and response timeout expired" error in profile setup process
- **Callback Answer Error Handling**: Added try-catch blocks around all `callback.answer()` calls to handle expired callback queries gracefully
- **Profile Setup Stability**: Improved error handling in `complete_profile_setup`, `process_allergies`, and other callback handlers
- **User Experience**: Users no longer see errors when callback queries expire during profile setup

## [0.3.60] - 2025-07-20

### Fixed
- **Profile Setup Error Handling**: Fixed UnboundLocalError in `complete_profile_setup` function caused by missing `user_language` variable in exception handling blocks
- **Exception Block Variable Scope**: Added proper `user_language` initialization in `except ValueError` and `except Exception` blocks
- **Profile Setup Flow**: Ensured consistent variable scope throughout the profile setup process including all error handling paths
- **Test Suite**: Verified core nutrition calculation and formatting tests pass successfully

## [0.3.59] - 2025-07-20

### Fixed
- **Profile Setup Error Handling**: Fixed UnboundLocalError in `complete_profile_setup` function caused by duplicate `user_language` variable definitions in exception handling blocks
- **Exception Block Variable Scope**: Removed duplicate `user_language` definitions in `except ValueError` and `except Exception` blocks
- **Profile Setup Flow**: Ensured consistent variable scope throughout the profile setup process including error handling

## [0.3.58] - 2025-07-20

### Fixed
- **Profile Setup Variable Scope**: Fixed UnboundLocalError in `process_dietary_preferences` function caused by duplicate `user_language` variable definition
- **Variable Scope Conflict**: Removed duplicate `user_language` definition in the `diet_done` block that was causing variable scope conflicts
- **Profile Setup Flow**: Ensured consistent variable scope throughout the profile setup process

## [0.3.57] - 2025-07-20

### Fixed
- **Profile Setup Completion Error**: Fixed UnboundLocalError in `complete_profile_setup` function where `user_language` variable was not defined at the beginning of the function
- **Profile Setup Flow**: Moved `user_language` initialization to the start of `complete_profile_setup` to ensure it's available throughout the function
- **Profile Setup Error Handling**: Removed duplicate `user_language` definitions and streamlined error handling in profile completion process

## [0.3.56] - 2025-07-20

### Fixed
- **Profile Display Enhancement**: Added dietary preferences and allergies information to profile display
- **Profile Display Translation**: All profile fields now show translated values instead of English codes
- **Profile Display Format**: Fixed duplicate emojis and units in profile display (e.g., "üë® üë® –ú—É–∂—Å–∫–æ–π", "170 —Å–º —Å–º")
- **Macro Distribution Error**: Fixed KeyError 'protein_g' in nutrition section by correcting data structure access
- **Payment Service Error**: Added proper error handling for ServerDisconnectedError in payment processing
- **Payment Error Translation**: Added Russian translation for payment service unavailable message
- **Dietary Preferences Error**: Fixed UnboundLocalError in `process_dietary_preferences` function
- **Profile Completion Translation**: Fixed NameError in `process_allergies` function where `user_language` variable was not defined
- **Final Profile Message**: Completely translated the profile setup completion message to Russian
- **Profile Summary Translation**: All profile summary fields now use proper Russian translations:
  - Age, Height, Weight, Activity, Goal, Diet, Allergies
  - Daily calorie target message
  - Completion status messages
- **Profile Completion Buttons**: Translated all 4 buttons in the final profile setup screen:
  - "üìä –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–Ω–µ–≤–Ω–æ–π –ø–ª–∞–Ω" (View Daily Plan)
  - "üçï –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –µ–¥—É" (Analyze Food)
  - "üçΩÔ∏è –ü–æ–ª—É—á–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç" (Get Recipe)
  - "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é" (Main Menu)
- **Dietary Preferences Translation**: Added comprehensive Russian translations for all dietary preferences:
  - Vegetarian, Vegan, Pescatarian, Keto, Paleo, Mediterranean
  - Low Carb, Low Fat, Gluten Free, Dairy Free, Halal, Kosher
- **Allergies Translation**: Added comprehensive Russian translations for all allergies:
  - Nuts, Peanuts, Shellfish, Fish, Eggs, Dairy, Soy, Wheat, Gluten, Sesame, Sulfites
- **Profile Display Enhancement**: Added dietary preferences and allergies sections to profile display with proper translations

### Added
- **Profile Display Sections**: Added dedicated sections for dietary preferences and allergies in profile display
- **Translation Keys**: Added new translation keys for profile display enhancements
- **Error Handling**: Enhanced error handling for payment service connectivity issues

## [0.3.55] - 2025-07-20

### Fixed
- **Profile Completion Translation**: Fixed NameError in `process_allergies` function where `user_language` variable was not defined
- **Final Profile Message**: Completely translated the profile setup completion message to Russian
- **Profile Summary Translation**: All profile summary fields now use proper Russian translations:
  - Age, Height, Weight, Activity, Goal, Diet, Allergies
  - Daily calorie target message
  - Completion status messages
- **Profile Completion Buttons**: Translated all 4 buttons in the final profile setup screen:
  - "üìä –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–Ω–µ–≤–Ω–æ–π –ø–ª–∞–Ω" (View Daily Plan)
  - "üçï –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –µ–¥—É" (Analyze Food)
  - "üçΩÔ∏è –ü–æ–ª—É—á–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç" (Get Recipe)
  - "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é" (Main Menu)
- **Dietary Preferences Translation**: Added comprehensive Russian translations for all dietary preferences:
  - Vegetarian, Vegan, Pescatarian, Keto, Paleo, Mediterranean
  - Low Carb, Low Fat, Gluten Free, Dairy Free, Halal, Kosher
- **Allergies Translation**: Added comprehensive Russian translations for all allergies:
  - Nuts, Peanuts, Shellfish, Fish, Eggs, Dairy, Soy, Wheat, Gluten, Sesame, Sulfites

### Added
- **Translation Keys**: Added new translation keys for profile completion and dietary information
- **Profile Completion Flow**: Enhanced profile completion with comprehensive Russian translations

## [0.3.54] - 2025-07-20

### Fixed
- **Profile Setup Translation**: Fixed UnboundLocalError in `process_age` and `process_goal` functions where `user_language` variable was not defined
- **Telegram Markdown Error**: Fixed TelegramBadRequest "can't parse entities" error by removing `parse_mode="Markdown"` from messages containing emojis
- **Profile Setup Flow**: Ensured all profile setup steps use proper Russian translations with emoji support
- **Gender Selection**: Fixed gender selection step with proper Russian translations and emoji display
- **Activity Level Selection**: Enhanced activity level descriptions with detailed Russian translations
- **Goal Selection**: Improved goal selection step with clear Russian translations and emoji indicators
- **Dietary Preferences**: Enhanced dietary preferences step with comprehensive Russian translations and emoji indicators
- **Allergies Selection**: Improved allergies selection step with clear Russian translations and emoji indicators

### Added
- **Enhanced Translations**: Added comprehensive Russian translations for all profile setup steps
- **Emoji Support**: Added emoji indicators for better user experience in profile setup
- **Error Handling**: Improved error handling for Telegram message formatting issues

## [0.3.53] - 2025-07-20

### Fixed
- **Profile Setup Translation**: Fixed translation issues in 8-step profile setup process
- **Gender Selection**: Improved clarity and completeness of gender selection translations
- **Allergies Translation**: Enhanced allergies selection with better Russian translations
- **Dietary Preferences**: Improved dietary preferences selection with comprehensive Russian translations
- **Profile Setup Flow**: Enhanced overall profile setup flow with better user experience

### Added
- **Enhanced Translations**: Added comprehensive Russian translations for profile setup steps
- **User Experience**: Improved clarity and completeness of all profile setup messages

## [0.3.0] - 2025-07-20

### Fixed
- **Profile Setup Translation**: Fixed translation issues in profile setup process
- **Gender Selection**: Improved gender selection translations
- **Allergies Selection**: Enhanced allergies selection translations
- **Dietary Preferences**: Improved dietary preferences translations

### Added
- **Enhanced Translations**: Added comprehensive Russian translations for profile setup

*Note: Versions 0.3.1-0.3.52 contained similar translation fixes and improvements that were consolidated in later versions.*