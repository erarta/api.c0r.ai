# –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö c0r.ai ‚Üí AIDI.APP

*–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: 27 —è–Ω–≤–∞—Ä—è 2025*
*–¶–µ–ª—å: –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ö–µ–º—ã –ë–î –æ—Ç –∞–Ω–∞–ª–∏–∑–∞ –ø–∏—Ç–∞–Ω–∏—è –∫ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏/KYC*

## üìä –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º—ã c0r.ai

### –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã (—Å–æ—Ö—Ä–∞–Ω—è–µ–º)
```sql
-- –ë–∞–∑–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã (–∞–¥–∞–ø—Ç–∏—Ä—É–µ–º)
users                    -- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è–º–∏
user_profiles            -- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –ø–æ–ª–µ–π
credits                  -- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)
payments                 -- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)
schema_migrations        -- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º (—Å–∏—Å—Ç–µ–º–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞)

-- –¢–∞–±–ª–∏—Ü—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã –¥–ª—è –ø–∏—Ç–∞–Ω–∏—è)
nutrition_analyses       -- ‚ùå –£–¥–∞–ª—è–µ–º
recipes                  -- ‚ùå –£–¥–∞–ª—è–µ–º  
daily_stats             -- ‚ùå –£–¥–∞–ª—è–µ–º
food_items              -- ‚ùå –£–¥–∞–ª—è–µ–º
meal_plans              -- ‚ùå –£–¥–∞–ª—è–µ–º
```

### –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã (—Å–æ–∑–¥–∞–µ–º)
```sql
-- –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã AIDI.APP
reputation_analyses      -- ‚ûï –ê–Ω–∞–ª–∏–∑—ã —Ä–µ–ø—É—Ç–∞—Ü–∏–∏
deepfake_detections     -- ‚ûï –î–µ—Ç–µ–∫—Ü–∏—è –¥–∏–ø—Ñ–µ–π–∫–æ–≤
reputation_sources      -- ‚ûï –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–ø—É—Ç–∞—Ü–∏–∏
kyc_verifications       -- ‚ûï KYC –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
analysis_reports        -- ‚ûï –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç—ã
```

## üîÑ –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (Pre-migration)

#### 1.1 –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞ —Ç–µ–∫—É—â–µ–π –ë–î
pg_dump -h [supabase_host] -U [user] -d [database] > c0r_ai_backup_$(date +%Y%m%d).sql

# –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
pg_dump -h [supabase_host] -U [user] -d [database] --schema-only > c0r_ai_schema.sql
```

#### 1.2 –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–µ–π
SELECT 
    tc.table_name, 
    kcu.column_name, 
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name 
FROM information_schema.table_constraints AS tc 
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY';
```

### –≠—Ç–∞–ø 2: –ú–∏–≥—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

#### 2.1 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã users
```sql
-- –ú–∏–≥—Ä–∞—Ü–∏—è: 2025-01-27_update_users_for_aidi.sql
-- –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è AIDI.APP

ALTER TABLE users 
ADD COLUMN IF NOT EXISTS timezone VARCHAR(50) DEFAULT 'Europe/Moscow',
ADD COLUMN IF NOT EXISTS last_activity_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
ADD COLUMN IF NOT EXISTS reputation_score INTEGER DEFAULT NULL,
ADD COLUMN IF NOT EXISTS verification_status VARCHAR(50) DEFAULT 'unverified';

-- –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
CREATE INDEX IF NOT EXISTS idx_users_telegram_id ON users(telegram_id);
CREATE INDEX IF NOT EXISTS idx_users_last_activity ON users(last_activity_at);
CREATE INDEX IF NOT EXISTS idx_users_verification_status ON users(verification_status);

-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
COMMENT ON COLUMN users.timezone IS 'User timezone for localized timestamps';
COMMENT ON COLUMN users.last_activity_at IS 'Last user activity timestamp';
COMMENT ON COLUMN users.reputation_score IS 'User own reputation score (0-100)';
COMMENT ON COLUMN users.verification_status IS 'KYC verification status: unverified, pending, verified, rejected';
```

#### 2.2 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã user_profiles
```sql
-- –ú–∏–≥—Ä–∞—Ü–∏—è: 2025-01-27_update_user_profiles_for_aidi.sql
-- –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ–¥ AIDI.APP

-- –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—è, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è –ø–∏—Ç–∞–Ω–∏—è
ALTER TABLE user_profiles 
DROP COLUMN IF EXISTS dietary_preferences,
DROP COLUMN IF EXISTS health_goals,
DROP COLUMN IF EXISTS activity_level,
DROP COLUMN IF EXISTS daily_calorie_target;

-- –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è AIDI.APP
ALTER TABLE user_profiles
ADD COLUMN IF NOT EXISTS analysis_preferences JSONB DEFAULT '{"reputation_depth": "basic", "deepfake_sensitivity": "medium"}',
ADD COLUMN IF NOT EXISTS data_retention_days INTEGER DEFAULT 30,
ADD COLUMN IF NOT EXISTS api_access_enabled BOOLEAN DEFAULT FALSE,
ADD COLUMN IF NOT EXISTS api_key VARCHAR(255) DEFAULT NULL,
ADD COLUMN IF NOT EXISTS usage_statistics JSONB DEFAULT '{"analyses_count": 0, "deepfake_checks": 0}';

-- –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
UPDATE user_profiles 
SET notification_settings = '{"reputation_alerts": true, "deepfake_alerts": true, "payment_notifications": true}'
WHERE notification_settings = '{}' OR notification_settings IS NULL;

UPDATE user_profiles 
SET privacy_settings = '{"data_sharing": false, "anonymous_analytics": true, "report_sharing": false}'
WHERE privacy_settings = '{}' OR privacy_settings IS NULL;

-- –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã
CREATE INDEX IF NOT EXISTS idx_user_profiles_api_key ON user_profiles(api_key) WHERE api_key IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_user_profiles_subscription ON user_profiles(subscription_type, subscription_expires_at);

-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
COMMENT ON COLUMN user_profiles.analysis_preferences IS 'User preferences for reputation and deepfake analysis';
COMMENT ON COLUMN user_profiles.data_retention_days IS 'How long to keep user analysis data (GDPR compliance)';
COMMENT ON COLUMN user_profiles.api_access_enabled IS 'Whether user has API access enabled';
COMMENT ON COLUMN user_profiles.api_key IS 'API key for programmatic access';
COMMENT ON COLUMN user_profiles.usage_statistics IS 'User usage statistics and quotas';
```

### –≠—Ç–∞–ø 3: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü AIDI.APP

#### 3.1 –¢–∞–±–ª–∏—Ü–∞ reputation_analyses
```sql
-- –ú–∏–≥—Ä–∞—Ü–∏—è: 2025-01-27_create_reputation_analyses.sql
CREATE TABLE reputation_analyses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- –î–∞–Ω–Ω—ã–µ —Ü–µ–ª–∏ –∞–Ω–∞–ª–∏–∑–∞
    target_name VARCHAR(255),
    target_phone VARCHAR(50),
    target_email VARCHAR(255),
    target_photo_url TEXT,
    target_social_profiles JSONB DEFAULT '{}', -- {"vk": "id123", "telegram": "@username"}
    
    -- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–Ω–∞–ª–∏–∑–∞
    analysis_type VARCHAR(50) NOT NULL CHECK (analysis_type IN ('basic', 'extended', 'deep')),
    search_depth VARCHAR(50) DEFAULT 'standard' CHECK (search_depth IN ('surface', 'standard', 'deep')),
    data_sources JSONB DEFAULT '[]', -- ["social_media", "public_records", "news", "courts"]
    
    -- –°—Ç–∞—Ç—É—Å –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    status VARCHAR(50) DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'failed', 'cancelled')),
    progress_percentage INTEGER DEFAULT 0 CHECK (progress_percentage >= 0 AND progress_percentage <= 100),
    
    -- –°–∫–æ—Ä—ã –∏ –º–µ—Ç—Ä–∏–∫–∏
    risk_score INTEGER CHECK (risk_score >= 0 AND risk_score <= 100),
    credibility_score INTEGER CHECK (credibility_score >= 0 AND credibility_score <= 100),
    sentiment_score DECIMAL(3,2) CHECK (sentiment_score >= -1.00 AND sentiment_score <= 1.00),
    activity_score INTEGER CHECK (activity_score >= 0 AND activity_score <= 100),
    
    -- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
    results JSONB DEFAULT '{}',
    summary TEXT,
    recommendations TEXT,
    sources_found INTEGER DEFAULT 0,
    red_flags JSONB DEFAULT '[]',
    positive_indicators JSONB DEFAULT '[]',
    
    -- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    credits_used INTEGER DEFAULT 1,
    processing_time_ms INTEGER,
    ai_model_version VARCHAR(50),
    error_message TEXT,
    
    -- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    started_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    expires_at TIMESTAMP WITH TIME ZONE DEFAULT (NOW() + INTERVAL '30 days')
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
CREATE INDEX idx_reputation_analyses_user_id ON reputation_analyses(user_id);
CREATE INDEX idx_reputation_analyses_status ON reputation_analyses(status);
CREATE INDEX idx_reputation_analyses_created_at ON reputation_analyses(created_at DESC);
CREATE INDEX idx_reputation_analyses_target_phone ON reputation_analyses(target_phone) WHERE target_phone IS NOT NULL;
CREATE INDEX idx_reputation_analyses_target_email ON reputation_analyses(target_email) WHERE target_email IS NOT NULL;
CREATE INDEX idx_reputation_analyses_expires_at ON reputation_analyses(expires_at);

-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
COMMENT ON TABLE reputation_analyses IS 'Reputation analysis requests and results';
COMMENT ON COLUMN reputation_analyses.risk_score IS 'Overall risk score (0-100, higher = more risky)';
COMMENT ON COLUMN reputation_analyses.credibility_score IS 'Credibility score (0-100, higher = more credible)';
COMMENT ON COLUMN reputation_analyses.sentiment_score IS 'Overall sentiment (-1.0 to 1.0, negative to positive)';
COMMENT ON COLUMN reputation_analyses.expires_at IS 'When this analysis data will be automatically deleted';
```

#### 3.2 –¢–∞–±–ª–∏—Ü–∞ deepfake_detections
```sql
-- –ú–∏–≥—Ä–∞—Ü–∏—è: 2025-01-27_create_deepfake_detections.sql
CREATE TABLE deepfake_detections (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- –ú–µ–¥–∏–∞—Ñ–∞–π–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    media_url TEXT NOT NULL,
    media_type VARCHAR(20) NOT NULL CHECK (media_type IN ('image', 'video', 'audio')),
    file_size_bytes BIGINT,
    file_format VARCHAR(20),
    duration_seconds DECIMAL(10,3), -- –¥–ª—è –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ
    resolution VARCHAR(20), -- "1920x1080"
    frame_rate DECIMAL(6,3), -- –¥–ª—è –≤–∏–¥–µ–æ
    
    -- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–Ω–∞–ª–∏–∑–∞
    analysis_type VARCHAR(50) NOT NULL CHECK (analysis_type IN ('quick', 'standard', 'detailed', 'forensic')),
    detection_models JSONB DEFAULT '[]', -- ["face_detection", "temporal_analysis", "compression_artifacts"]
    
    -- –°—Ç–∞—Ç—É—Å
    status VARCHAR(50) DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'failed', 'cancelled')),
    progress_percentage INTEGER DEFAULT 0 CHECK (progress_percentage >= 0 AND progress_percentage <= 100),
    
    -- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–µ—Ç–µ–∫—Ü–∏–∏
    deepfake_probability DECIMAL(5,4) CHECK (deepfake_probability >= 0.0000 AND deepfake_probability <= 1.0000),
    confidence_score DECIMAL(5,4) CHECK (confidence_score >= 0.0000 AND confidence_score <= 1.0000),
    authenticity_score DECIMAL(5,4) CHECK (authenticity_score >= 0.0000 AND authenticity_score <= 1.0000),
    
    -- –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    detection_details JSONB DEFAULT '{}',
    artifacts_found JSONB DEFAULT '[]',
    technical_analysis JSONB DEFAULT '{}',
    face_analysis JSONB DEFAULT '{}',
    temporal_analysis JSONB DEFAULT '{}',
    
    -- –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
    verdict VARCHAR(50) CHECK (verdict IN ('authentic', 'likely_authentic', 'suspicious', 'likely_deepfake', 'deepfake')),
    explanation TEXT,
    recommendations TEXT,
    
    -- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    credits_used INTEGER DEFAULT 1,
    processing_time_ms INTEGER,
    ai_model_version VARCHAR(50),
    error_message TEXT,
    
    -- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    started_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    expires_at TIMESTAMP WITH TIME ZONE DEFAULT (NOW() + INTERVAL '30 days')
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_deepfake_detections_user_id ON deepfake_detections(user_id);
CREATE INDEX idx_deepfake_detections_status ON deepfake_detections(status);
CREATE INDEX idx_deepfake_detections_created_at ON deepfake_detections(created_at DESC);
CREATE INDEX idx_deepfake_detections_media_type ON deepfake_detections(media_type);
CREATE INDEX idx_deepfake_detections_verdict ON deepfake_detections(verdict);
CREATE INDEX idx_deepfake_detections_expires_at ON deepfake_detections(expires_at);

-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
COMMENT ON TABLE deepfake_detections IS 'Deepfake detection analysis requests and results';
COMMENT ON COLUMN deepfake_detections.deepfake_probability IS 'Probability that media is a deepfake (0.0-1.0)';
COMMENT ON COLUMN deepfake_detections.confidence_score IS 'Confidence in the detection result (0.0-1.0)';
COMMENT ON COLUMN deepfake_detections.authenticity_score IS 'Probability that media is authentic (0.0-1.0)';
```

#### 3.3 –¢–∞–±–ª–∏—Ü–∞ reputation_sources
```sql
-- –ú–∏–≥—Ä–∞—Ü–∏—è: 2025-01-27_create_reputation_sources.sql
CREATE TABLE reputation_sources (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    analysis_id UUID NOT NULL REFERENCES reputation_analyses(id) ON DELETE CASCADE,
    
    -- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏—Å—Ç–æ—á–Ω–∏–∫–µ
    source_type VARCHAR(100) NOT NULL, -- 'vk', 'telegram', 'instagram', 'court_records', 'news', etc.
    source_name VARCHAR(255), -- "VKontakte", "–°—É–¥–µ–±–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è", "–†–ò–ê –ù–æ–≤–æ—Å—Ç–∏"
    source_url TEXT,
    source_category VARCHAR(50), -- 'social_media', 'public_records', 'news', 'professional'
    
    -- –ù–∞–π–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    data_found JSONB DEFAULT '{}',
    content_type VARCHAR(50), -- 'profile', 'post', 'comment', 'article', 'record'
    content_summary TEXT,
    content_date TIMESTAMP WITH TIME ZONE,
    
    -- –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö
    relevance_score DECIMAL(3,2) CHECK (relevance_score >= 0.00 AND relevance_score <= 1.00),
    credibility_score DECIMAL(3,2) CHECK (credibility_score >= 0.00 AND credibility_score <= 1.00),
    sentiment DECIMAL(3,2) CHECK (sentiment >= -1.00 AND sentiment <= 1.00),
    impact_score DECIMAL(3,2) CHECK (impact_score >= 0.00 AND impact_score <= 1.00),
    
    -- –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è
    risk_indicators JSONB DEFAULT '[]',
    positive_indicators JSONB DEFAULT '[]',
    tags JSONB DEFAULT '[]',
    
    -- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    extraction_method VARCHAR(50), -- 'api', 'scraping', 'manual'
    data_quality VARCHAR(50) DEFAULT 'good' CHECK (data_quality IN ('poor', 'fair', 'good', 'excellent')),
    verification_status VARCHAR(50) DEFAULT 'unverified' CHECK (verification_status IN ('unverified', 'verified', 'disputed')),
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_reputation_sources_analysis_id ON reputation_sources(analysis_id);
CREATE INDEX idx_reputation_sources_source_type ON reputation_sources(source_type);
CREATE INDEX idx_reputation_sources_relevance ON reputation_sources(relevance_score DESC);
CREATE INDEX idx_reputation_sources_content_date ON reputation_sources(content_date DESC);

-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
COMMENT ON TABLE reputation_sources IS 'Individual data sources found during reputation analysis';
COMMENT ON COLUMN reputation_sources.relevance_score IS 'How relevant this source is to the target person (0.0-1.0)';
COMMENT ON COLUMN reputation_sources.impact_score IS 'How much this source impacts overall reputation (0.0-1.0)';
```

#### 3.4 –¢–∞–±–ª–∏—Ü–∞ kyc_verifications
```sql
-- –ú–∏–≥—Ä–∞—Ü–∏—è: 2025-01-27_create_kyc_verifications.sql
CREATE TABLE kyc_verifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
    verification_type VARCHAR(50) NOT NULL CHECK (verification_type IN ('document', 'selfie', 'video', 'biometric')),
    document_type VARCHAR(50), -- 'passport', 'driver_license', 'id_card'
    
    -- –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    document_front_url TEXT,
    document_back_url TEXT,
    selfie_url TEXT,
    video_url TEXT,
    
    -- –°—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
    status VARCHAR(50) DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'approved', 'rejected', 'expired')),
    verification_level VARCHAR(50) DEFAULT 'basic' CHECK (verification_level IN ('basic', 'enhanced', 'premium')),
    
    -- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏
    document_authenticity_score DECIMAL(3,2),
    face_match_score DECIMAL(3,2),
    liveness_score DECIMAL(3,2),
    overall_confidence DECIMAL(3,2),
    
    -- –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    extracted_data JSONB DEFAULT '{}', -- –∏–º—è, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è, –Ω–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ —Ç.–¥.
    verification_details JSONB DEFAULT '{}',
    
    -- –ü—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
    rejection_reasons JSONB DEFAULT '[]',
    manual_review_notes TEXT,
    
    -- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    credits_used INTEGER DEFAULT 2,
    processing_time_ms INTEGER,
    ai_model_version VARCHAR(50),
    
    -- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    processed_at TIMESTAMP WITH TIME ZONE,
    expires_at TIMESTAMP WITH TIME ZONE DEFAULT (NOW() + INTERVAL '1 year')
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_kyc_verifications_user_id ON kyc_verifications(user_id);
CREATE INDEX idx_kyc_verifications_status ON kyc_verifications(status);
CREATE INDEX idx_kyc_verifications_verification_type ON kyc_verifications(verification_type);
CREATE INDEX idx_kyc_verifications_expires_at ON kyc_verifications(expires_at);

-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
COMMENT ON TABLE kyc_verifications IS 'KYC (Know Your Customer) verification requests and results';
COMMENT ON COLUMN kyc_verifications.document_authenticity_score IS 'How authentic the document appears (0.0-1.0)';
COMMENT ON COLUMN kyc_verifications.face_match_score IS 'How well selfie matches document photo (0.0-1.0)';
COMMENT ON COLUMN kyc_verifications.liveness_score IS 'Liveness detection score for selfie/video (0.0-1.0)';
```

### –≠—Ç–∞–ø 4: –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ç–∞–±–ª–∏—Ü

#### 4.1 –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –ø–∏—Ç–∞–Ω–∏—è
```sql
-- –ú–∏–≥—Ä–∞—Ü–∏—è: 2025-01-27_cleanup_nutrition_tables.sql
-- –í–ù–ò–ú–ê–ù–ò–ï: –í—ã–ø–æ–ª–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏!

-- –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏
ALTER TABLE nutrition_analyses DROP CONSTRAINT IF EXISTS nutrition_analyses_user_id_fkey;
ALTER TABLE recipes DROP CONSTRAINT IF EXISTS recipes_user_id_fkey;
ALTER TABLE daily_stats DROP CONSTRAINT IF EXISTS daily_stats_user_id_fkey;

-- –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (–Ω–∞ —Å–ª—É—á–∞–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è)
CREATE TABLE IF NOT EXISTS _archive_nutrition_analyses AS SELECT * FROM nutrition_analyses;
CREATE TABLE IF NOT EXISTS _archive_recipes AS SELECT * FROM recipes;
CREATE TABLE IF NOT EXISTS _archive_daily_stats AS SELECT * FROM daily_stats;

-- –£–¥–∞–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
DROP TABLE IF EXISTS nutrition_analyses CASCADE;
DROP TABLE IF EXISTS recipes CASCADE;
DROP TABLE IF EXISTS daily_stats CASCADE;
DROP TABLE IF EXISTS food_items CASCADE;
DROP TABLE IF EXISTS meal_plans CASCADE;

-- –£–¥–∞–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã (–µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å)
DROP INDEX IF EXISTS idx_nutrition_analyses_user_id;
DROP INDEX IF EXISTS idx_recipes_user_id;
DROP INDEX IF EXISTS idx_daily_stats_user_id;
```

### –≠—Ç–∞–ø 5: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∫—Ä–µ–¥–∏—Ç–æ–≤

#### 5.1 –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã credits
```sql
-- –ú–∏–≥—Ä–∞—Ü–∏—è: 2025-01-27_update_credits_system.sql
-- –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ç–∏–ø—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è AIDI.APP

-- –û–±–Ω–æ–≤–ª—è–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
ALTER TABLE credits 
DROP CONSTRAINT IF EXISTS credits_transaction_type_check;

ALTER TABLE credits 
ADD CONSTRAINT credits_transaction_type_check 
CHECK (transaction_type IN (
    'purchase', 'usage', 'refund', 'bonus', 'promotion',
    'reputation_analysis', 'deepfake_detection', 'kyc_verification',
    'api_usage', 'premium_feature'
));

-- –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª—è
ALTER TABLE credits
ADD COLUMN IF NOT EXISTS service_type VARCHAR(50), -- 'reputation', 'deepfake', 'kyc'
ADD COLUMN IF NOT EXISTS analysis_complexity VARCHAR(50), -- 'basic', 'extended', 'deep'
ADD COLUMN IF NOT EXISTS metadata JSONB DEFAULT '{}';

-- –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏
UPDATE credits 
SET service_type = 'legacy', 
    metadata = '{"migrated_from": "nutrition_system"}'
WHERE service_type IS NULL;

-- –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã
CREATE INDEX IF NOT EXISTS idx_credits_service_type ON credits(service_type);
CREATE INDEX IF NOT EXISTS idx_credits_transaction_type ON credits(transaction_type);

-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
COMMENT ON COLUMN credits.service_type IS 'Type of service: reputation, deepfake, kyc, api, premium';
COMMENT ON COLUMN credits.analysis_complexity IS 'Complexity level affecting credit cost';
COMMENT ON COLUMN credits.metadata IS 'Additional transaction metadata';
```

### –≠—Ç–∞–ø 6: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π (Views)

#### 6.1 –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
```sql
-- –ú–∏–≥—Ä–∞—Ü–∏—è: 2025-01-27_create_analytics_views.sql

-- –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
CREATE OR REPLACE VIEW user_analytics AS
SELECT 
    u.id,
    u.telegram_id,
    u.created_at as registration_date,
    u.last_activity_at,
    up.subscription_type,
    
    -- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–æ–≤ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏
    COALESCE(ra_stats.total_analyses, 0) as reputation_analyses_count,
    COALESCE(ra_stats.completed_analyses, 0) as completed_reputation_analyses,
    COALESCE(ra_stats.avg_risk_score, 0) as avg_risk_score,
    
    -- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏ –¥–∏–ø—Ñ–µ–π–∫–æ–≤
    COALESCE(df_stats.total_detections, 0) as deepfake_detections_count,
    COALESCE(df_stats.completed_detections, 0) as completed_deepfake_detections,
    COALESCE(df_stats.avg_deepfake_probability, 0) as avg_deepfake_probability,
    
    -- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤
    COALESCE(credit_stats.total_purchased, 0) as total_credits_purchased,
    COALESCE(credit_stats.total_used, 0) as total_credits_used,
    COALESCE(credit_stats.current_balance, 0) as current_credit_balance

FROM users u
LEFT JOIN user_profiles up ON u.id = up.user_id
LEFT JOIN (
    SELECT 
        user_id,
        COUNT(*) as total_analyses,
        COUNT(*) FILTER (WHERE status = 'completed') as completed_analyses,
        AVG(risk_score) FILTER (WHERE status = 'completed') as avg_risk_score
    FROM reputation_analyses 
    GROUP BY user_id
) ra_stats ON u.id = ra_stats.user_id
LEFT JOIN (
    SELECT 
        user_id,
        COUNT(*) as total_detections,
        COUNT(*) FILTER (WHERE status = 'completed') as completed_detections,
        AVG(deepfake_probability) FILTER (WHERE status = 'completed') as avg_deepfake_probability
    FROM deepfake_detections 
    GROUP BY user_id
) df_stats ON u.id = df_stats.user_id
LEFT JOIN (
    SELECT 
        user_id,
        SUM(amount) FILTER (WHERE transaction_type = 'purchase') as total_purchased,
        SUM(amount) FILTER (WHERE transaction_type LIKE '%usage%' OR transaction_type LIKE '%_analysis' OR transaction_type LIKE '%_detection') as total_used,
        SUM(amount) as current_balance
    FROM credits 
    GROUP BY user_id
) credit_stats ON u.id = credit_stats.user_id;

-- –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
CREATE OR REPLACE VIEW system_analytics AS
SELECT 
    -- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    (SELECT COUNT(*) FROM users) as total_users,
    (SELECT COUNT(*) FROM users WHERE created_at > NOW() - INTERVAL '30 days') as new_users_30d,
    (SELECT COUNT(*) FROM users WHERE last_activity_at > NOW() - INTERVAL '7 days') as active_users_7d,
    
    -- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–æ–≤
    (SELECT COUNT(*) FROM reputation_analyses) as total_reputation_analyses,
    (SELECT COUNT(*) FROM reputation_analyses WHERE created_at > NOW() - INTERVAL '24 hours') as reputation_analyses_24h,
    (SELECT COUNT(*) FROM deepfake_detections) as total_deepfake_detections,
    (SELECT COUNT(*) FROM deepfake_detections WHERE created_at > NOW() - INTERVAL '24 hours') as deepfake_detections_24h,
    
    -- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
    (SELECT COUNT(*) FROM payments WHERE status = 'completed') as successful_payments,
    (SELECT SUM(amount) FROM payments WHERE status = 'completed') as total_revenue,
    (SELECT SUM(amount) FROM payments WHERE status = 'completed' AND created_at > NOW() - INTERVAL '30 days') as revenue_30d;
```

## üîß –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

### –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
```python
# scripts/migrate_to_aidi.py
"""
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö c0r.ai ‚Üí AIDI.APP
"""
import os
import sys
import asyncio
from datetime import datetime
from supabase import create_client, Client
from loguru import logger

class AIDIMigration:
    def __init__(self):
        self.supabase: Client = create_client(
            os.getenv("SUPABASE_URL"),
            os.getenv("SUPABASE_SERVICE_ROLE_KEY")
        )
        
    async def run_migration(self):
        """–ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏"""
        try:
            logger.info("üöÄ –ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é c0r.ai ‚Üí AIDI.APP")
            
            # –≠—Ç–∞–ø 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
            await self.create_backup()
            
            # –≠—Ç–∞–ø 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü
            await self.update_user_tables()
            
            # –≠—Ç–∞–ø 3: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü
            await self.create_new_tables()
            
            # –≠—Ç–∞–ø 4: –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
            await self.migrate_data()
            
            # –≠—Ç–∞–ø 5: –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ç–∞–±–ª–∏—Ü
            await self.cleanup_old_tables()
            
            # –≠—Ç–∞–ø 6: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
            await self.create_views()
            
            # –≠—Ç–∞–ø 7: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
            await self.update_indexes()
            
            logger.success("‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏: {e}")
            await self.rollback()
            raise
    
    async def create_backup(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏"""
        logger.info("üì¶ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏...")
        # –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞
        
    async def update_user_tables(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü"""
        logger.info("üë• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü...")
        # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL –º–∏–≥—Ä–∞—Ü–∏–π –¥–ª—è users –∏ user_profiles
        
    async def create_new_tables(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü AIDI.APP"""
        logger.info("üÜï –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü...")
        # –°–æ–∑–¥–∞–Ω–∏–µ reputation_analyses, deepfake_detections –∏ —Ç.–¥.
        
    async def migrate_data(self):
        """–ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö"""
        logger.info("üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö...")
        # –ü–µ—Ä–µ–Ω–æ—Å –∫—Ä–µ–¥–∏—Ç–æ–≤, –ø–ª–∞—Ç–µ–∂–µ–π –∏ –¥—Ä—É–≥–∏—Ö –¥–∞–Ω–Ω—ã—Ö
        
    async def cleanup_old_tables(self):
        """–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ç–∞–±–ª–∏—Ü"""
        logger.info("üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ç–∞–±–ª–∏—Ü...")
        # –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –ø–∏—Ç–∞–Ω–∏—è
        
    async def create_views(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π"""
        logger.info("üëÅÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π...")
        # –°–æ–∑–¥–∞–Ω–∏–µ