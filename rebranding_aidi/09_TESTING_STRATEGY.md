# –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è AIDI.APP

*–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: 27 —è–Ω–≤–∞—Ä—è 2025*
*–¶–µ–ª—å: –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏ –∏ KYC*

## üéØ –û–±–∑–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è AIDI.APP –æ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —É—Ä–æ–≤–Ω–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è - –æ—Ç unit —Ç–µ—Å—Ç–æ–≤ –¥–æ end-to-end —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ. –û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ —É–¥–µ–ª—è–µ—Ç—Å—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é AI-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã.

### –ü–∏—Ä–∞–º–∏–¥–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```mermaid
graph TB
    subgraph "Testing Pyramid"
        E2E[End-to-End Tests<br/>~10 tests<br/>UI, Integration, User Flows]
        INT[Integration Tests<br/>~50 tests<br/>API, Database, External Services]
        UNIT[Unit Tests<br/>~200 tests<br/>Functions, Classes, Components]
    end
    
    subgraph "Specialized Testing"
        AI[AI Model Testing<br/>Accuracy, Performance]
        SEC[Security Testing<br/>Penetration, Vulnerability]
        PERF[Performance Testing<br/>Load, Stress, Scalability]
        COMP[Compliance Testing<br/>GDPR, 152-–§–ó, Data Privacy]
    end
```

## üß™ Unit —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ unit —Ç–µ—Å—Ç–æ–≤

```
tests/unit/
‚îú‚îÄ‚îÄ test_reputation_analysis.py      # –¢–µ—Å—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ test_deepfake_detection.py       # –¢–µ—Å—Ç—ã –¥–µ—Ç–µ–∫—Ü–∏–∏ –¥–∏–ø—Ñ–µ–π–∫–æ–≤
‚îú‚îÄ‚îÄ test_kyc_verification.py         # –¢–µ—Å—Ç—ã KYC –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ test_bot_handlers.py             # –¢–µ—Å—Ç—ã Telegram bot handlers
‚îú‚îÄ‚îÄ test_fsm_states.py               # –¢–µ—Å—Ç—ã FSM —Å–æ—Å—Ç–æ—è–Ω–∏–π
‚îú‚îÄ‚îÄ test_payment_processing.py       # –¢–µ—Å—Ç—ã –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
‚îú‚îÄ‚îÄ test_credit_system.py            # –¢–µ—Å—Ç—ã —Å–∏—Å—Ç–µ–º—ã –∫—Ä–µ–¥–∏—Ç–æ–≤
‚îú‚îÄ‚îÄ test_ai_clients.py               # –¢–µ—Å—Ç—ã AI –∫–ª–∏–µ–Ω—Ç–æ–≤
‚îú‚îÄ‚îÄ test_data_validation.py          # –¢–µ—Å—Ç—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
‚îî‚îÄ‚îÄ test_security_utils.py           # –¢–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
```

### –ü—Ä–∏–º–µ—Ä—ã unit —Ç–µ—Å—Ç–æ–≤

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏
```python
# tests/unit/test_reputation_analysis.py
import pytest
import sys
import os
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..', '..')))

from services.ml.reputation.analyzer import ReputationAnalyzer
from services.ml.reputation.scoring.risk_calculator import RiskCalculator

class TestReputationAnalysis:
    """–¢–µ—Å—Ç—ã —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏"""
    
    def setup_method(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º"""
        self.analyzer = ReputationAnalyzer()
        self.risk_calculator = RiskCalculator()
        
    def test_basic_reputation_analysis_with_valid_data(self):
        """–¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏ —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏"""
        # Arrange
        input_data = {
            "target_name": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
            "target_phone": "+79001234567",
            "analysis_type": "basic"
        }
        
        # Act
        result = self.analyzer.analyze_person(input_data)
        
        # Assert
        assert result is not None
        assert "risk_score" in result
        assert "credibility_score" in result
        assert 0 <= result["risk_score"] <= 100
        assert 0 <= result["credibility_score"] <= 100
        
    def test_risk_score_calculation_with_negative_indicators(self):
        """–¢–µ—Å—Ç —Ä–∞—Å—á–µ—Ç–∞ —Ä–∏—Å–∫-—Å–∫–æ—Ä–∞ —Å –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–º–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏"""
        # Arrange
        data = {
            "court_records": [{"type": "criminal", "severity": "high"}],
            "negative_news": [{"sentiment": -0.8, "source": "reliable"}],
            "social_red_flags": ["suspicious_activity", "fake_profiles"]
        }
        
        # Act
        risk_score = self.risk_calculator.calculate_risk_score(data)
        
        # Assert
        assert risk_score > 60  # –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫
        assert isinstance(risk_score, int)
        
    def test_sentiment_analysis_with_mixed_content(self):
        """–¢–µ—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Å–æ —Å–º–µ—à–∞–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º"""
        # Arrange
        content = [
            {"text": "–û—Ç–ª–∏—á–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç, —Ä–µ–∫–æ–º–µ–Ω–¥—É—é!", "source": "review"},
            {"text": "–ë—ã–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º —Ä–∞–±–æ—Ç—ã", "source": "complaint"},
            {"text": "–ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–±–æ—Ç–µ", "source": "news"}
        ]
        
        # Act
        sentiment_score = self.analyzer.analyze_sentiment(content)
        
        # Assert
        assert -1.0 <= sentiment_score <= 1.0
        assert isinstance(sentiment_score, float)
        
    def test_reputation_analysis_with_insufficient_data(self):
        """–¢–µ—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏ —Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏"""
        # Arrange
        input_data = {
            "target_name": "",  # –ü—É—Å—Ç–æ–µ –∏–º—è
            "analysis_type": "basic"
        }
        
        # Act & Assert
        with pytest.raises(ValueError, match="Insufficient data"):
            self.analyzer.analyze_person(input_data)
            
    def test_data_source_integration(self):
        """–¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö"""
        # Arrange
        search_params = {
            "name": "–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
            "sources": ["vk", "public_records"]
        }
        
        # Act
        sources_data = self.analyzer.collect_data_from_sources(search_params)
        
        # Assert
        assert isinstance(sources_data, dict)
        assert "vk" in sources_data or "public_records" in sources_data
        for source, data in sources_data.items():
            assert "relevance_score" in data
            assert 0.0 <= data["relevance_score"] <= 1.0
```

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–µ–∫—Ü–∏–∏ –¥–∏–ø—Ñ–µ–π–∫–æ–≤
```python
# tests/unit/test_deepfake_detection.py
import pytest
from unittest.mock import Mock, patch
from services.ml.deepfake.detector import DeepfakeDetector

class TestDeepfakeDetection:
    """–¢–µ—Å—Ç—ã —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–µ—Ç–µ–∫—Ü–∏–∏ –¥–∏–ø—Ñ–µ–π–∫–æ–≤"""
    
    def setup_method(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º"""
        self.detector = DeepfakeDetector()
        
    def test_image_deepfake_detection_authentic(self):
        """–¢–µ—Å—Ç –¥–µ—Ç–µ–∫—Ü–∏–∏ –¥–∏–ø—Ñ–µ–π–∫–∞ –¥–ª—è –ø–æ–¥–ª–∏–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
        # Arrange
        image_path = "tests/fixtures/authentic_image.jpg"
        
        # Act
        result = self.detector.analyze_image(image_path)
        
        # Assert
        assert result is not None
        assert "deepfake_probability" in result
        assert "confidence_score" in result
        assert 0.0 <= result["deepfake_probability"] <= 1.0
        assert 0.0 <= result["confidence_score"] <= 1.0
        
    def test_video_deepfake_detection_with_temporal_analysis(self):
        """–¢–µ—Å—Ç –¥–µ—Ç–µ–∫—Ü–∏–∏ –¥–∏–ø—Ñ–µ–π–∫–∞ –≤ –≤–∏–¥–µ–æ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º"""
        # Arrange
        video_path = "tests/fixtures/test_video.mp4"
        
        # Act
        result = self.detector.analyze_video(video_path)
        
        # Assert
        assert "temporal_analysis" in result
        assert "face_analysis" in result
        assert "compression_analysis" in result
        assert result["temporal_analysis"]["inconsistencies_found"] is not None
        
    def test_confidence_scoring_algorithm(self):
        """–¢–µ—Å—Ç –∞–ª–≥–æ—Ä–∏—Ç–º–∞ —Ä–∞—Å—á–µ—Ç–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏"""
        # Arrange
        detection_results = {
            "face_inconsistencies": 0.3,
            "temporal_artifacts": 0.2,
            "compression_artifacts": 0.1,
            "metadata_analysis": 0.05
        }
        
        # Act
        confidence = self.detector.calculate_confidence(detection_results)
        
        # Assert
        assert 0.0 <= confidence <= 1.0
        assert isinstance(confidence, float)
        
    def test_unsupported_media_format(self):
        """–¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –º–µ–¥–∏–∞"""
        # Arrange
        unsupported_file = "tests/fixtures/document.pdf"
        
        # Act & Assert
        with pytest.raises(ValueError, match="Unsupported media format"):
            self.detector.analyze_image(unsupported_file)
            
    @patch('services.ml.ai_clients.openai.client.OpenAIDeepfakeClient')
    def test_ai_model_integration(self, mock_openai_client):
        """–¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å AI –º–æ–¥–µ–ª—å—é"""
        # Arrange
        mock_openai_client.return_value.detect_deepfake_image.return_value = {
            "deepfake_probability": 0.85,
            "confidence": 0.92,
            "explanation": "High probability deepfake detected"
        }
        
        # Act
        result = self.detector.detect_deepfake("test_image.jpg")
        
        # Assert
        assert result["deepfake_probability"] == 0.85
        assert result["confidence"] == 0.92
        mock_openai_client.return_value.detect_deepfake_image.assert_called_once()
```

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram bot
```python
# tests/unit/test_bot_handlers.py
import pytest
from unittest.mock import AsyncMock, Mock
from aiogram.types import Message, User, Chat
from services.api.bot.handlers.reputation import ReputationHandler

class TestBotHandlers:
    """–¢–µ—Å—Ç—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ Telegram –±–æ—Ç–∞"""
    
    def setup_method(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º"""
        self.handler = ReputationHandler()
        
    @pytest.fixture
    def mock_message(self):
        """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è mock —Å–æ–æ–±—â–µ–Ω–∏—è"""
        user = User(id=12345, is_bot=False, first_name="Test", username="testuser")
        chat = Chat(id=12345, type="private")
        return Message(
            message_id=1,
            date=None,
            chat=chat,
            from_user=user,
            content_type="text",
            text="test message"
        )
        
    @pytest.mark.asyncio
    async def test_reputation_menu_handler(self, mock_message):
        """–¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –º–µ–Ω—é —Ä–µ–ø—É—Ç–∞—Ü–∏–∏"""
        # Arrange
        mock_message.text = "üîç –ê–Ω–∞–ª–∏–∑ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏"
        
        # Act
        result = await self.handler.handle_reputation_menu(mock_message)
        
        # Assert
        assert result is not None
        assert "reputation analysis" in result.lower() or "–∞–Ω–∞–ª–∏–∑ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏" in result.lower()
        
    @pytest.mark.asyncio
    async def test_data_input_validation(self, mock_message):
        """–¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö"""
        # Arrange
        mock_message.text = "invalid_email_format"
        
        # Act
        result = await self.handler.validate_email_input(mock_message)
        
        # Assert
        assert result["valid"] is False
        assert "error" in result
        
    @pytest.mark.asyncio
    async def test_fsm_state_transition(self, mock_message):
        """–¢–µ—Å—Ç –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ FSM"""
        # Arrange
        from aiogram.fsm.context import FSMContext
        mock_state = AsyncMock(spec=FSMContext)
        
        # Act
        await self.handler.start_reputation_analysis(mock_message, mock_state)
        
        # Assert
        mock_state.set_state.assert_called_once()
```

## üîó Integration —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ integration —Ç–µ—Å—Ç–æ–≤

```
tests/integration/
‚îú‚îÄ‚îÄ test_api_endpoints.py            # –¢–µ—Å—Ç—ã API endpoints
‚îú‚îÄ‚îÄ test_database_operations.py      # –¢–µ—Å—Ç—ã –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ë–î
‚îú‚îÄ‚îÄ test_external_services.py        # –¢–µ—Å—Ç—ã –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
‚îú‚îÄ‚îÄ test_payment_flow.py             # –¢–µ—Å—Ç—ã –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
‚îú‚îÄ‚îÄ test_telegram_integration.py     # –¢–µ—Å—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Telegram
‚îú‚îÄ‚îÄ test_ai_service_integration.py   # –¢–µ—Å—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å AI —Å–µ—Ä–≤–∏—Å–∞–º–∏
‚îú‚îÄ‚îÄ test_file_storage.py             # –¢–µ—Å—Ç—ã —Ñ–∞–π–ª–æ–≤–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
‚îî‚îÄ‚îÄ test_notification_system.py      # –¢–µ—Å—Ç—ã —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```

### –ü—Ä–∏–º–µ—Ä—ã integration —Ç–µ—Å—Ç–æ–≤

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API endpoints
```python
# tests/integration/test_api_endpoints.py
import pytest
import httpx
import asyncio
from fastapi.testclient import TestClient
from services.api.main import app

class TestAPIEndpoints:
    """–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã API endpoints"""
    
    def setup_method(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º"""
        self.client = TestClient(app)
        self.base_url = "http://testserver"
        
    def test_reputation_analysis_endpoint(self):
        """–¢–µ—Å—Ç endpoint –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏"""
        # Arrange
        payload = {
            "target_name": "–¢–µ—Å—Ç –¢–µ—Å—Ç–æ–≤",
            "target_phone": "+79001234567",
            "analysis_type": "basic"
        }
        headers = {"Authorization": "Bearer test_token"}
        
        # Act
        response = self.client.post(
            "/api/v1/reputation/analyze",
            json=payload,
            headers=headers
        )
        
        # Assert
        assert response.status_code == 200
        data = response.json()
        assert "analysis_id" in data
        assert "status" in data
        assert data["status"] == "pending"
        
    def test_deepfake_detection_endpoint(self):
        """–¢–µ—Å—Ç endpoint –¥–µ—Ç–µ–∫—Ü–∏–∏ –¥–∏–ø—Ñ–µ–π–∫–æ–≤"""
        # Arrange
        files = {"media": ("test.jpg", open("tests/fixtures/test_image.jpg", "rb"), "image/jpeg")}
        data = {"analysis_type": "quick"}
        
        # Act
        response = self.client.post(
            "/api/v1/deepfake/detect",
            files=files,
            data=data
        )
        
        # Assert
        assert response.status_code == 200
        result = response.json()
        assert "detection_id" in result
        assert "status" in result
        
    def test_analysis_status_endpoint(self):
        """–¢–µ—Å—Ç endpoint —Å—Ç–∞—Ç—É—Å–∞ –∞–Ω–∞–ª–∏–∑–∞"""
        # Arrange
        analysis_id = "test-analysis-id-123"
        
        # Act
        response = self.client.get(f"/api/v1/reputation/analysis/{analysis_id}")
        
        # Assert
        assert response.status_code in [200, 404]  # 404 –µ—Å–ª–∏ –∞–Ω–∞–ª–∏–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω
        
    def test_credit_balance_endpoint(self):
        """–¢–µ—Å—Ç endpoint –±–∞–ª–∞–Ω—Å–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤"""
        # Arrange
        headers = {"Authorization": "Bearer test_token"}
        
        # Act
        response = self.client.get("/api/v1/user/credits", headers=headers)
        
        # Assert
        assert response.status_code == 200
        data = response.json()
        assert "balance" in data
        assert isinstance(data["balance"], int)
```

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```python
# tests/integration/test_database_operations.py
import pytest
import asyncpg
from services.common.database.models import User, ReputationAnalysis
from services.common.database.connection import get_db_connection

class TestDatabaseOperations:
    """–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –æ–ø–µ—Ä–∞—Ü–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö"""
    
    @pytest.fixture
    async def db_connection(self):
        """–§–∏–∫—Å—Ç—É—Ä–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î"""
        conn = await get_db_connection(test_mode=True)
        yield conn
        await conn.close()
        
    @pytest.mark.asyncio
    async def test_user_creation_and_retrieval(self, db_connection):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        # Arrange
        user_data = {
            "telegram_id": 123456789,
            "username": "testuser",
            "first_name": "Test",
            "last_name": "User"
        }
        
        # Act - Create user
        user_id = await User.create(db_connection, **user_data)
        
        # Act - Retrieve user
        user = await User.get_by_telegram_id(db_connection, 123456789)
        
        # Assert
        assert user is not None
        assert user["telegram_id"] == 123456789
        assert user["username"] == "testuser"
        
    @pytest.mark.asyncio
    async def test_reputation_analysis_workflow(self, db_connection):
        """–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ workflow –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏"""
        # Arrange
        user_id = await User.create(db_connection, telegram_id=987654321, first_name="Test")
        analysis_data = {
            "user_id": user_id,
            "target_name": "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
            "analysis_type": "basic",
            "status": "pending"
        }
        
        # Act - Create analysis
        analysis_id = await ReputationAnalysis.create(db_connection, **analysis_data)
        
        # Act - Update status
        await ReputationAnalysis.update_status(db_connection, analysis_id, "processing")
        
        # Act - Complete analysis
        results = {
            "risk_score": 25,
            "credibility_score": 85,
            "sentiment_score": 0.6,
            "sources_found": 12
        }
        await ReputationAnalysis.complete(db_connection, analysis_id, results)
        
        # Assert
        analysis = await ReputationAnalysis.get_by_id(db_connection, analysis_id)
        assert analysis["status"] == "completed"
        assert analysis["risk_score"] == 25
        assert analysis["credibility_score"] == 85
        
    @pytest.mark.asyncio
    async def test_credit_transactions(self, db_connection):
        """–¢–µ—Å—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∫—Ä–µ–¥–∏—Ç–æ–≤"""
        # Arrange
        user_id = await User.create(db_connection, telegram_id=555666777, first_name="Credit Test")
        
        # Act - Add credits
        await Credit.add_credits(db_connection, user_id, 100, "purchase", "Test purchase")
        
        # Act - Use credits
        await Credit.use_credits(db_connection, user_id, 5, "reputation_analysis", "Basic analysis")
        
        # Act - Get balance
        balance = await Credit.get_balance(db_connection, user_id)
        
        # Assert
        assert balance == 95
        
        # Act - Get transaction history
        transactions = await Credit.get_transactions(db_connection, user_id)
        assert len(transactions) == 2
        assert transactions[0]["transaction_type"] == "purchase"
        assert transactions[1]["transaction_type"] == "reputation_analysis"
```

## üåê End-to-End —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### E2E —Ç–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

```python
# tests/e2e/test_user_journey.py
import pytest
from playwright.async_api import async_playwright
import asyncio

class TestUserJourney:
    """End-to-end —Ç–µ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤"""
    
    @pytest.mark.asyncio
    async def test_complete_reputation_analysis_flow(self):
        """–ü–æ–ª–Ω—ã–π E2E —Ç–µ—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏"""
        async with async_playwright() as p:
            # Arrange
            browser = await p.chromium.launch(headless=False)
            context = await browser.new_context()
            page = await context.new_page()
            
            try:
                # Act 1: Open Telegram Web and start bot
                await page.goto("https://web.telegram.org")
                await page.wait_for_selector('[data-testid="search-input"]')
                await page.fill('[data-testid="search-input"]', "@AIDIReputationBot")
                await page.press('[data-testid="search-input"]', "Enter")
                
                # Act 2: Start conversation
                await page.click('[data-testid="start-button"]')
                await page.wait_for_selector('[data-testid="message-text"]')
                
                # Act 3: Navigate to reputation analysis
                await page.click('text="üîç –ê–Ω–∞–ª–∏–∑ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏"')
                
                # Act 4: Enter analysis data
                await page.click('text="üìù –í–≤–µ—Å—Ç–∏ –∏–º—è"')
                await page.fill('[data-testid="message-input"]', "–¢–µ—Å—Ç –¢–µ—Å—Ç–æ–≤–∏—á")
                await page.press('[data-testid="message-input"]', "Enter")
                
                # Act 5: Start analysis
                await page.click('text="üöÄ –ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑"')
                
                # Act 6: Wait for results
                await page.wait_for_selector('text="‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω"', timeout=60000)
                
                # Assert
                analysis_result = await page.text_content('[data-testid="analysis-result"]')
                assert "–†–∏—Å–∫-—Å–∫–æ—Ä:" in analysis_result
                assert "–î–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å:" in analysis_result
                
            finally:
                await browser.close()
                
    @pytest.mark.asyncio
    async def test_payment_and_credit_purchase_flow(self):
        """E2E —Ç–µ—Å—Ç –ø–æ–∫—É–ø–∫–∏ –∫—Ä–µ–¥–∏—Ç–æ–≤"""
        # –¢–µ—Å—Ç –ø–æ–∫—É–ø–∫–∏ –∫—Ä–µ–¥–∏—Ç–æ–≤ —á–µ—Ä–µ–∑ Stripe/YooKassa
        # –í–∫–ª—é—á–∞–µ—Ç –≤–µ—Å—å flow –æ—Ç –≤—ã–±–æ—Ä–∞ –ø–∞–∫–µ—Ç–∞ –¥–æ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤
        pass
        
    @pytest.mark.asyncio
    async def test_deepfake_detection_flow(self):
        """E2E —Ç–µ—Å—Ç –¥–µ—Ç–µ–∫—Ü–∏–∏ –¥–∏–ø—Ñ–µ–π–∫–æ–≤"""
        # –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–µ—Ç–µ–∫—Ü–∏–∏
        pass
```

## ü§ñ AI Model —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ AI –º–æ–¥–µ–ª–µ–π

```python
# tests/ai/test_model_accuracy.py
import pytest
import numpy as np
from sklearn.metrics import accuracy_score, precision_score, recall_score
from services.ml.deepfake.detector import DeepfakeDetector
from services.ml.reputation.analyzer import ReputationAnalyzer

class TestAIModelAccuracy:
    """–¢–µ—Å—Ç—ã —Ç–æ—á–Ω–æ—Å—Ç–∏ AI –º–æ–¥–µ–ª–µ–π"""
    
    def setup_method(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        self.deepfake_detector = DeepfakeDetector()
        self.reputation_analyzer = ReputationAnalyzer()
        
    def test_deepfake_detection_accuracy(self):
        """–¢–µ—Å—Ç —Ç–æ—á–Ω–æ—Å—Ç–∏ –¥–µ—Ç–µ–∫—Ü–∏–∏ –¥–∏–ø—Ñ–µ–π–∫–æ–≤"""
        # Arrange - –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –¥–∞—Ç–∞—Å–µ—Ç
        test_dataset = self.load_deepfake_test_dataset()
        predictions = []
        ground_truth = []
        
        # Act
        for sample in test_dataset:
            result = self.deepfake_detector.detect_deepfake(sample["media_path"])
            predictions.append(1 if result["deepfake_probability"] > 0.5 else 0)
            ground_truth.append(sample["is_deepfake"])
            
        # Assert
        accuracy = accuracy_score(ground_truth, predictions)
        precision = precision_score(ground_truth, predictions)
        recall = recall_score(ground_truth, predictions)
        
        assert accuracy >= 0.90  # –ú–∏–Ω–∏–º—É–º 90% —Ç–æ—á–Ω–æ—Å—Ç–∏
        assert precision >= 0.85  # –ú–∏–Ω–∏–º—É–º 85% precision
        assert recall >= 0.85     # –ú–∏–Ω–∏–º—É–º 85% recall
        
    def test_reputation_scoring_consistency(self):
        """–¢–µ—Å—Ç –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —Å–∫–æ—Ä–∏–Ω–≥–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏"""
        # Arrange
        test_profiles = self.load_reputation_test_profiles()
        
        # Act - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
        for profile in test_profiles:
            scores = []
            for _ in range(5):  # 5 –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤
                result = self.reputation_analyzer.analyze_person(profile)
                scores.append(result["risk_score"])
                
            # Assert - –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (—Ä–∞–∑–±—Ä–æ—Å –Ω–µ –±–æ–ª–µ–µ 10 –ø—É–Ω–∫—Ç–æ–≤)
            score_std = np.std(scores)
            assert score_std <= 10, f"Inconsistent scoring for profile {profile['name']}"
            
    def load_deepfake_test_dataset(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞ –¥–ª—è –¥–∏–ø—Ñ–µ–π–∫–æ–≤"""
        return [
            {"media_path": "tests/fixtures/authentic_video1.mp4", "is_deepfake": 0},
            {"media_path": "tests/fixtures/deepfake_video1.mp4", "is_deepfake": 1},
            # ... –±–æ–ª—å—à–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –æ–±—Ä–∞–∑—Ü–æ–≤
        ]
        
    def load_reputation_test_profiles(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏"""
        return [
            {"name": "–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –ü—Ä–æ—Ñ–∏–ª—å", "expected_risk": "low"},
            {"name": "–ù–µ–≥–∞—Ç–∏–≤–Ω—ã–π –ü—Ä–æ—Ñ–∏–ª—å", "expected_risk": "high"},
            # ... –±–æ–ª—å—à–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
        ]
```

## üîí Security —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```python
# tests/security/test_security.py
import pytest
import requests
from services.api.main import app
from fastapi.testclient import TestClient

class TestSecurity:
    """–¢–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    
    def setup_method(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º"""
        self.client = TestClient(app)
        
    def test_sql_injection_protection(self):
        """–¢–µ—Å—Ç –∑–∞—â–∏—Ç—ã –æ—Ç SQL –∏–Ω—ä–µ–∫—Ü–∏–π"""
        # Arrange
        malicious_payload = {
            "target_name": "'; DROP TABLE users; --",
            "analysis_type": "basic"
        }
        
        # Act
        response = self.client.post("/api/v1/reputation/analyze", json=malicious_payload)
        
        # Assert
        assert response.status_code in [400, 422]  # –î–æ–ª–∂–µ–Ω –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å
        
    def test_xss_protection(self):
        """–¢–µ—Å—Ç –∑–∞—â–∏—Ç—ã –æ—Ç XSS –∞—Ç–∞–∫"""
        # Arrange
        xss_payload = {
            "target_name": "<script>alert('XSS')</script>",
            "analysis_type": "basic"
        }
        
        # Act
        response = self.client.post("/api/v1/reputation/analyze", json=xss_payload)
        
        # Assert
        if response.status_code == 200:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω –≤ –æ—Ç–≤–µ—Ç–µ
            assert "<script>" not in response.text
            
    def test_rate_limiting(self):
        """–¢–µ—Å—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤"""
        # Arrange
        payload = {"target_name": "Test User", "analysis_type": "basic"}
        
        # Act - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–¥—Ä—è–¥
        responses = []
        for _ in range(20):
            response = self.client.post("/api/v1/reputation/analyze", json=payload)
            responses.append(response.status_code)
            
        # Assert - –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∏—Ç—å 429 (Too Many Requests)
        assert 429 in responses
        
    def test_authentication_required(self):
        """–¢–µ—Å—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
        # Act
        response = self.client.get("/api/v1/user/profile")
        
        # Assert
        assert response.status_code == 401  # Unauthorized
        
    def test_data_encryption_in_transit(self):
        """–¢–µ—Å—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ API endpoints –∏—Å–ø–æ–ª—å–∑—É—é—Ç HTTPS
        # –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–æ–ª—å–∫–æ HTTPS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        pass
        
    def test_sensitive_data_not_logged(self):
        """–¢–µ—Å—Ç —á—Ç–æ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –ª–æ–≥–∏"""
        # Arrange
        payload = {
            "target_name": "–°–µ–∫—Ä–µ—Ç–Ω–æ–µ –ò–º—è",
            "target_phone": "+79001234567",
            "analysis_type": "basic"
        }
        
        # Act
        response = self.client.post("/api/v1/reputation/analyze", json=payload)
        
        # Assert - –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º —Ç–µ—Å—Ç–µ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª—ã –ª–æ–≥–æ–≤)
        # –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –¥–æ–ª–∂–Ω—ã –ø–æ–ø–∞–¥–∞—Ç—å –≤ –ª–æ–≥–∏ –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ
        pass
```

## ‚ö° Performance —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
# tests/performance/test_load.py
import asyncio
import aiohttp
import time
from concurrent.futures import ThreadPoolExecutor
import statistics

class TestPerformance:
    """–¢–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã"""
    
    def test_concurrent_reputation_analyses(self):
        """–¢–µ—Å—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏"""
        # Arrange
        concurrent_requests = 50
        base_url = "https://api.aidi.app"
        
        # Act
        start_time = time.time()
        with ThreadPoolExecutor(max_workers=concurrent_requests) as executor:
            futures = []
            for i in range(concurrent_requests):
                future = executor.submit(self.make_reputation_request, base_url, i)
                futures.append(future)
                
            results = [future.result() for future in futures]
        end_time = time.time()
        
        # Assert
        successful_requests = [r for r in results if r["success"]]
        response_times = [r["response_time"] for r in successful_requests]
        
        assert len(successful_requests) >= concurrent_requests * 0.95  # 95% success rate
        assert statistics.mean(response_times) <= 5.0  # –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ <= 5 —Å–µ–∫
        assert max(response_times) <= 15.0  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è <= 15 —Å–µ–∫
        
    def make_reputation_request(self, base_url, request_id):
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏"""
        