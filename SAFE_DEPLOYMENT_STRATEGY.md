# üöÄ Safe Deployment Strategy for Database Constraints

## ‚ö†Ô∏è **–ü–†–û–ë–õ–ï–ú–ê: –°—Ç–∞—Ä—ã–π –∫–æ–¥ vs –ù–æ–≤—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**

–ï—Å–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é **–¥–æ** –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞ –±–æ—Ç–∞, —Å—Ç–∞—Ä—ã–π –±–æ—Ç –±—É–¥–µ—Ç –ø–∞–¥–∞—Ç—å:

### **–°—Ü–µ–Ω–∞—Ä–∏–∏ –ø–∞–¥–µ–Ω–∏—è:**
1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å** —Å –Ω–µ–ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (age: None)
2. **–°—Ç–∞—Ä—ã–π –∫–æ–¥** –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
3. **NOT NULL –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è** –æ—Ç–∫–ª–æ–Ω—è—é—Ç –∑–∞–ø—Ä–æ—Å
4. **–ë–æ—Ç –ø–∞–¥–∞–µ—Ç** —Å –æ—à–∏–±–∫–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### **–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–µ—Å—Ç–∞ –ø–∞–¥–µ–Ω–∏—è:**
- `create_user_profile()` - –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è
- `update_user_profile()` - –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è  
- `process_goal()` - –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è

## üîÑ **–ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–û–†–Ø–î–û–ö –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø**

### **–≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–ë–µ–∑–æ–ø–∞—Å–Ω–æ)**
```bash
# 1. –°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
# 2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å rollback —Å–∫—Ä–∏–ø—Ç
# 3. –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥ –±–æ—Ç–∞
```

### **–≠—Ç–∞–ø 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –±–æ—Ç–∞ (–°–Ω–∞—á–∞–ª–∞)**
```bash
# 1. –†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥ –±–æ—Ç–∞ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
# 2. –ù–æ–≤—ã–π –∫–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ –ë–î
# 3. –ë–æ—Ç –±–æ–ª—å—à–µ –Ω–µ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –Ω–µ–ø–æ–ª–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏
```

### **–≠—Ç–∞–ø 3: –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏ (–ü–æ—Ç–æ–º)**
```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ database_constraints.sql –≤ Supabase
# 2. –¢–µ–ø–µ—Ä—å –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞—â–∏—â–µ–Ω–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
# 3. –î–≤–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞: –∫–æ–¥ + –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
```

## üìã **–î–ï–¢–ê–õ–¨–ù–´–ô –ü–õ–ê–ù –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø**

### **–®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (5 –º–∏–Ω—É—Ç)**
1. ‚úÖ –°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
2. ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `database_constraints_rollback.sql` –≥–æ—Ç–æ–≤
3. ‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥ –±–æ—Ç–∞ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é

### **–®–∞–≥ 2: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞ (10 –º–∏–Ω—É—Ç)**
1. ‚úÖ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –±–æ—Ç
2. ‚úÖ –†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
3. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ
4. ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø—Ä–æ—Ñ–∏–ª–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### **–®–∞–≥ 3: –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏ (5 –º–∏–Ω—É—Ç)**
1. ‚úÖ –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard ‚Üí SQL Editor
2. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç–µ `database_constraints.sql`
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—Å–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å
4. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è

### **–®–∞–≥ 4: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (5 –º–∏–Ω—É—Ç)**
1. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –Ω–µ–ø–æ–ª–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è
3. ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –∫–∞–ª–æ—Ä–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç

## üö® **–ß–¢–û –î–ï–õ–ê–¢–¨ –ï–°–õ–ò –ß–¢–û-–¢–û –ü–û–®–õ–û –ù–ï –¢–ê–ö**

### **–ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—å:**
```sql
-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ Supabase SQL Editor
-- –ò—Å–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–æ–≤–∞
-- –ú–∏–≥—Ä–∞—Ü–∏—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞ - –±–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ
```

### **–ï—Å–ª–∏ –±–æ—Ç –Ω–∞—á–∞–ª –ø–∞–¥–∞—Ç—å –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:**
```sql
-- –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏:
-- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ database_constraints_rollback.sql –≤ SQL Editor
-- –ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Ç–∫–∞—Ç
-- –ò—Å–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ –±–æ—Ç–∞
-- –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
```

### **–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è:**
```sql
-- –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π –æ—Ç–∫–∞—Ç (–≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ SQL Editor):
DROP TRIGGER IF EXISTS trigger_calculate_calories ON user_profiles;
DROP FUNCTION IF EXISTS calculate_profile_calories();
ALTER TABLE user_profiles ALTER COLUMN age DROP NOT NULL;
ALTER TABLE user_profiles ALTER COLUMN gender DROP NOT NULL;
ALTER TABLE user_profiles ALTER COLUMN height_cm DROP NOT NULL;
ALTER TABLE user_profiles ALTER COLUMN weight_kg DROP NOT NULL;
ALTER TABLE user_profiles ALTER COLUMN activity_level DROP NOT NULL;
ALTER TABLE user_profiles ALTER COLUMN goal DROP NOT NULL;
```

## ‚úÖ **–ü–†–û–í–ï–†–ö–ò –ü–û–°–õ–ï –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø**

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è**
```bash
# 1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ /profile –±–æ—Ç—É
# 2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è (–≤–æ–∑—Ä–∞—Å—Ç, –ø–æ–ª, —Ä–æ—Å—Ç, –≤–µ—Å, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, —Ü–µ–ª—å)
# 3. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
# 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∫–∞–ª–æ—Ä–∏–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–µ–ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è**
```bash
# 1. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å —Å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
# 2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –±–æ—Ç –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –Ω–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
# 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–æ–Ω—è—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏
```

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**
```sql
-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å:
SELECT column_name, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'user_profiles' 
AND column_name IN ('age', 'gender', 'height_cm', 'weight_kg', 'activity_level', 'goal');

-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä —Å–æ–∑–¥–∞–ª—Å—è:
SELECT trigger_name FROM information_schema.triggers 
WHERE event_object_table = 'user_profiles';
```

## üéØ **–†–ï–ó–£–õ–¨–¢–ê–¢ –ü–û–°–õ–ï –£–°–ü–ï–®–ù–û–ì–û –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø**

### **–î–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è:**
- ‚ùå –ù–µ–ø–æ–ª–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å (age: None)
- ‚ùå –ë–æ—Ç –ø–∞–¥–∞–ª –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –∫–∞–ª–æ—Ä–∏–π
- ‚ùå –ù–µ—Ç –∑–∞—â–∏—Ç—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### **–ü–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è:**
- ‚úÖ –ù–µ–ø–æ–ª–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–¥–∞
- ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∑–∞—â–∏—â–µ–Ω–∞ NOT NULL
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –∫–∞–ª–æ—Ä–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –î–≤–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞: –∫–æ–¥ + –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

## üìû **–ü–û–î–î–ï–†–ñ–ö–ê**

–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±–æ—Ç–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SQL Editor –Ω–∞ –æ—à–∏–±–∫–∏ –º–∏–≥—Ä–∞—Ü–∏–∏
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ rollback —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
4. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ –æ—Ç–∫–∞—Ç—É

---

**–ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ: –°–Ω–∞—á–∞–ª–∞ –∫–æ–¥, –ø–æ—Ç–æ–º –º–∏–≥—Ä–∞—Ü–∏—è!** üéØ 